@using CERP.Setup.DTOs;
@using Syncfusion.EJ2.Grids;
@using CERP;
@{
    var initialToolBar = new List<object>() { new { text = "Show Actions", tooltipText = "Actions", prefixIcon = "e-custom-show-actions", id = "showActions" }, "Search", "ColumnChooser" };
    var fullToolBar = new List<object>() { new { text = "Hide Actions", tooltipText = "Actions", prefixIcon = "e-custom-hide-actions", id = "hideActions" }, new { text = "Toggle Grouping", tooltipText = "Grouping", prefixIcon = "zmdi-chevron-up", id = "toggleGrouping" }, new { text = "Toggle Detailed", tooltipText = "Toggle Detailed", prefixIcon = "e-toggledetailed", id = "toggleDetailed" }, "ExcelExport", "CsvExport", "Print", "Search", "Delete", new { text = "Copy", tooltipText = "Copy", prefixIcon = "e-copy", id = "copy" }, new { text = "Copy With Header", tooltipText = "Copy With Header", prefixIcon = "e-copy", id = "copyHeader" }, "ColumnChooser" };

    List<object> loanRequestsCommands = new List<object>();
    loanRequestsCommands.Add(new { type = "Edit", buttonOption = new { iconCss = "e-icons e-edit", cssClass = "e-flat" } });
    loanRequestsCommands.Add(new { type = "Delete", buttonOption = new { iconCss = "e-icons e-delete", cssClass = "e-flat" } });
    loanRequestsCommands.Add(new
    {
        type = "Cancel",
        buttonOption = new { iconCss = "e-icons e-cancel-icon", cssClass = "e-flat" }
    });

    List<GridColumn> loanRequestsGridColumns = new List<GridColumn>()
    {
        new GridColumn { Field = "id", Width = "80", HeaderText = "", Visible=false, ShowInColumnChooser=false, TextAlign=TextAlign.Center, MinWidth="10", IsPrimaryKey=true  },
        new GridColumn { Field = "title", Width = "110", HeaderText = "Title", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "titleLocalized", Width = "110", HeaderText = "Title (In Arabic)", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "prefix", Width = "110", HeaderText = "Prefix", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "startingNo", Width = "110", HeaderText = "Starting No", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "loanType.value", Width = "110", HeaderText = "Loan Type", TextAlign=TextAlign.Center,  MinWidth="10"  },
        //new GridColumn { Field = "getAllDepartments", Width = "110", HeaderText = "Department", TextAlign=TextAlign.Center,  MinWidth="10"  },
        //new GridColumn { Field = "getAllPositions", Width = "110", HeaderText = "Position", TextAlign=TextAlign.Center,  MinWidth="10"  },
        //new GridColumn { Field = "getAllEmploymentTypes", Width = "110", HeaderText = "Employment Type", TextAlign=TextAlign.Center,  MinWidth="10"  },
        //new GridColumn { Field = "getAllEmployeeStatuses", Width = "110", HeaderText = "Employment Status", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "", HeaderText = "Eligibility", TextAlign=TextAlign.Center,  MinWidth="10", Columns = new List<GridColumn>(){
                new GridColumn { Field = "minEmployeeDependants", Width = "110", HeaderText = "Minimum Dependants", TextAlign=TextAlign.Center,  MinWidth="10"  },
                new GridColumn { Field = "maxIndemnityLimit", Width = "110", HeaderText = "Maximum Indemnity", TextAlign=TextAlign.Center,  MinWidth="10"  },
                new GridColumn { Field = "maxInstallmentsLimit", Width = "110", HeaderText = "Maximum Installments", TextAlign=TextAlign.Center,  MinWidth="10"  },
                new GridColumn { Field = "maxInstallmentAmount", Width = "110", HeaderText = "Maximum Installment Amount", TextAlign=TextAlign.Center,  MinWidth="10"  },
            }
        },
        new GridColumn { Width = "150", HeaderText = "Actions", TextAlign=TextAlign.Center, MinWidth="10", Commands = loanRequestsCommands }
    };

    List<object> lrApprovalRouteCommands = new List<object>();
    lrApprovalRouteCommands.Add(new { type = "Delete", buttonOption = new { iconCss = "e-icons e-delete", cssClass = "e-flat e-DeleteButton" } });
    lrApprovalRouteCommands.Add(new { type = "Cancel", buttonOption = new { iconCss = "e-icons e-cancel-icon", cssClass = "e-flat" } });
    lrApprovalRouteCommands.Add(new { type = "Save", buttonOption = new { iconCss = "e-icons e-update", cssClass = "e-flat" } });
    lrApprovalRouteCommands.Add(new { type = "MoveUp", buttonOption = new { iconCss = "e-icons e-c-moveup", cssClass = "e-flat" } });
    lrApprovalRouteCommands.Add(new { type = "MoveDown", buttonOption = new { iconCss = "e-icons e-c-movedown", cssClass = "e-flat" } });
    lrApprovalRouteCommands.Add(new { type = "Edit", buttonOption = new { iconCss = "e-icons e-edit", cssClass = "e-flat" } });

    List<GridColumn> lrApprovalRouteGridColumns = new List<GridColumn>()
    {
        new GridColumn { Field = "id", Visible=false, ShowInColumnChooser=false, IsPrimaryKey=true  },
        new GridColumn { Field = "apId", Visible=false, ShowInColumnChooser=false },
        new GridColumn { Field = "routeIndex", Visible = false, HeaderText = "Route Index", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "active", AllowSorting = false, AutoFit=true, HeaderText = "Active", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "notifyEmployee", AllowSorting = false, AutoFit=true, HeaderText = "Notify", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "isPoster", AllowSorting = false, AutoFit=true, HeaderText = "Allow Posting", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllDepartmentNames", AllowSorting = false, AutoFit=true, HeaderText = "Department", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllPositionTitles", AllowSorting = false, AutoFit=true, HeaderText = "Position", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllEmployeeNames", AllowSorting = false,AutoFit=true, HeaderText = "Employee", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Width = "50", HeaderText = "Actions", TextAlign=TextAlign.Center, MinWidth="10", Commands = lrApprovalRouteCommands }
    };

    List<object> lrTasksCommands = new List<object>();
    lrTasksCommands.Add(new { type = "Delete", buttonOption = new { iconCss = "e-icons e-delete", cssClass = "e-flat e-DeleteButton" } });
    lrTasksCommands.Add(new { type = "Cancel", buttonOption = new { iconCss = "e-icons e-cancel-icon", cssClass = "e-flat" } });
    lrTasksCommands.Add(new { type = "Save", buttonOption = new { iconCss = "e-icons e-update", cssClass = "e-flat" } });
    lrTasksCommands.Add(new { type = "MoveUp", buttonOption = new { iconCss = "e-icons e-c-moveup", cssClass = "e-flat" } });
    lrTasksCommands.Add(new { type = "MoveDown", buttonOption = new { iconCss = "e-icons e-c-movedown", cssClass = "e-flat" } });
    lrTasksCommands.Add(new { type = "Edit", buttonOption = new { iconCss = "e-icons e-edit", cssClass = "e-flat" } });


    List<GridColumn> lrTasksGridColumns = new List<GridColumn>()
    {
        new GridColumn { Field = "id", Visible=false, ShowInColumnChooser=false, IsPrimaryKey=true  },
        new GridColumn { Field = "routeIndex", Visible = false, HeaderText = "Route Index", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "active", AllowSorting = false, AutoFit=true, HeaderText = "Active", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "notifyEmployee", AllowSorting = false, AutoFit=true, HeaderText = "Notify", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllDepartmentNames", AllowSorting = false, AutoFit=true, HeaderText = "Department", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllPositionTitles", AllowSorting = false, AutoFit=true, HeaderText = "Position", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllEmployeeNames", AllowSorting = false,AutoFit=true, HeaderText = "Employee", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "taskDescription", AllowSorting = false, AutoFit=true, HeaderText = "Description", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Width = "50", HeaderText = "Actions", TextAlign=TextAlign.Center, MinWidth="10", Commands = lrTasksCommands }
    };

    List<GridColumn> APTasksGridColumns = new List<GridColumn>()
    {
        new GridColumn { Field = "id", Visible=false, ShowInColumnChooser=false, IsPrimaryKey=true  },
        new GridColumn { Field = "apId", Visible=false, ShowInColumnChooser=false },
        new GridColumn { Field = "routeIndex", Visible = false, HeaderText = "Route Index", TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "active", AllowSorting = false, AutoFit=true, HeaderText = "Active", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "notifyEmployee", AllowSorting = false, AutoFit=true, HeaderText = "Notify", EditType="booleanEdit", DisplayAsCheckBox=true, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllDepartmentNames", AllowSorting = false, AutoFit=true, HeaderText = "Department", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllPositionTitles", AllowSorting = false, AutoFit=true, HeaderText = "Position", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "getAllEmployeeNames", AllowSorting = false,AutoFit=true, HeaderText = "Employee", AllowEditing=false, TextAlign=TextAlign.Center,  MinWidth="10"  },
        new GridColumn { Field = "taskDescription", AllowSorting = false, AutoFit=true, HeaderText = "Description", TextAlign=TextAlign.Center,  MinWidth="10"  },
    };

    Grid APSecondaryDetailsGrid = new Grid()
    {
        DataSource = new List<dynamic>(),
        QueryString = "apId",
        EditSettings = new Syncfusion.EJ2.Grids.GridEditSettings() { },
        AllowExcelExport = true,
        //AllowGrouping = true,
        AllowPdfExport = true,
        HierarchyPrintMode = HierarchyGridPrintMode.All,
        AllowSelection = true,
        AllowFiltering = false,
        AllowSorting = true,
        AllowMultiSorting = true,
        AllowResizing = true,
        GridLines = GridLine.Both,
        SearchSettings = new GridSearchSettings() { },
        //Toolbar = new List<object>() { "ExcelExport", "CsvExport", "Print", "Search",new { text = "Copy", tooltipText = "Copy", prefixIcon = "e-copy", id = "copy" }, new { text = "Copy With Header", tooltipText = "Copy With Header", prefixIcon = "e-copy", id = "copyHeader" } },
        //ContextMenuItems = new List<object>() { "AutoFit", "AutoFitAll", "SortAscending", "SortDescending", "Copy", "Edit", "Delete", "Save", "Cancel", "PdfExport", "ExcelExport", "CsvExport", "FirstPage", "PrevPage", "LastPage", "NextPage" },
        Columns = APTasksGridColumns

    };

}
    <script>
        isEditingLR = false;
        isEditingLRLoaded = false;
        var curLoansEditRow;

        $(document).ready(function () {
            //createSpinner({
            //    target: document.getElementById('loanRequestForm')
            //});
            var loansGrid = $("#AllLoanRequestsGrid")[0].ej2_instances[0];
            loansGrid.showSpinner();

            cERP.appServices.hR.loanRequestService.loanRequestTemplates.getAll(false).done(function (data) {
                loansGrid.hideSpinner();
                loansGrid.dataSource = data;
                loansGrid.refresh();
            });
            cERP.appServices.setup.lookup.dictionaryValue.getAllByValueType(ValueTypeModules.LoanType).done(function (data) {
                var loanTypes = [];
                $.each(data, function (i, d) {
                    loanTypes.push({ label: d.value, value: d.id });
                });
                $("#loansLoanTypeId").multiselect('dataprovider', loanTypes);
            });
            cERP.appServices.setup.lookup.dictionaryValue.getAllByValueType(ValueTypeModules.EmployeeType).done(function (data) {
                var employmentTypes = [];
                $.each(data, function (i, d) {
                    employmentTypes.push({ label: d.value, value: d.id });
                });
                $("#loansEmploymentTypeId").multiselect('dataprovider', employmentTypes);
            });
            cERP.appServices.setup.lookup.dictionaryValue.getAllByValueType(ValueTypeModules.EmployeeStatus).done(function (data) {
                var employmeeStatuses = [];
                $.each(data, function (i, d) {
                    employmeeStatuses.push({ label: d.value, value: d.id });
                });
                $("#loansEmployeeStatusId").multiselect('dataprovider', employmeeStatuses);
            });
            cERP.appServices.hR.holidayService.holidays.getAll().done(function (data) {
                var holidays = [];
                $.each(data, function (i, d) {
                    holidays.push({ label: d.title, value: d.id });
                });
                $("#loansHolidaysDeductionIds").multiselect('dataprovider', holidays);
            });

            //$.ajax({
            //    url: '?handler=LoanRequests',
            //    async: true,
            //    type: 'GET',
            //    data: {},
            //    success: function (data) {
            //        loansGrid.hideSpinner();
            //        loansGrid.dataSource = data;
            //        loansGrid.refresh();

            //        isLRLoaded = true;
            //    },
            //    error: function (err) {
            //        loansGrid.hideSpinner();
            //        isLRLoaded = false;
            //    }
            //});

            $('#addLoanRequestBtn').on('click', function () {
                $('#submitLoanRequestBtn').val('Add Loan Request');

                $('#loansTitle').val('');
                $('#loansTitleLocalized').val('');
                $('#loansPrefix').val('');
                $('#loansStartingNo').val('');

                //$('#loansLoanTypeId').multiselect('deselectAll', false);
                //$('#loansLoanTypeId').multiselect('updateButtonText');

                $('#loansDepartmentId').multiselect('deselectAll', false);
                $('#loansDepartmentId').multiselect('updateButtonText');
                $('#loansPositionId').multiselect('deselectAll', false);
                $('#loansPositionId').multiselect('updateButtonText');
                $('#loansEmploymentTypeId').multiselect('deselectAll', false);
                $('#loansEmploymentTypeId').multiselect('updateButtonText');
                $('#loansEmployeeStatusId').multiselect('deselectAll', false);
                $('#loansEmployeeStatusId').multiselect('updateButtonText');

                $('#loansMinEmployeeDependants').val('');
                $('#loansMaxIndemnityLimit').val('');
                $('#loansMaxInstallmentsLimit').val('');
                $('#loansMaxInstallmentAmount').val('');

                var apGrid = $("#LoansApprovalRouteGrid")[0].ej2_instances[0];
                apGrid.dataSource = [];
                apGrid.childGrid.dataSource = [];
                apGrid.dataSource.push({ id: 0, active: true, notifyEmployee: false, isPoster: false, isDepartmentHead: true, getAllDepartmentNames: "Selected", getAllPositionTitles: "Head", getAllEmployeeNames: "Auto", employees: [{ id: "@Guid.Empty", name: "Auto", position: { id: "@Guid.Empty", title: "Head" }, department: { id: "@Guid.Empty", name: "Selected" } }] })
                apGrid.dataSource.push({ id: 1, active: true, notifyEmployee: false, isPoster: false, isReportingTo: true, getAllDepartmentNames: "Selected", getAllPositionTitles: "Auto", getAllEmployeeNames: "Auto", employees: [{ id: "@Guid.Empty", name: "Auto [Reporting To]", position: { id: "@Guid.Empty", title: "Head" }, department: { id: "@Guid.Empty", name: "Selected" } }] })
                apGrid.refresh();

                var tasksGrid = $("#LoansTasksGrid")[0].ej2_instances[0];
                tasksGrid.dataSource = [];
            });

            $("#addToLoansApprovalRouteBtn").on('click', function (args) {
                var apGrid = $("#LoansApprovalRouteGrid")[0].ej2_instances[0];
                var depIds = $("#loansAPDepartmentId").val();
                var posIds = $("#loansAPPositionId").val();
                var selectedEmpIds = $("#loansAPEmployeeId").val();
                var emps = curLoansAPEmployees;

                var employees = [];
                for (var i = 0; i < selectedEmpIds.length; i++) {
                    var emp = emps.find(x => x.id == selectedEmpIds[i]);
                    employees.push(
                        {
                            employeeId: emp.id,
                            name: emp.name,
                            department: { id: emp.departmentId, name: emp.depName },
                            position: { id: emp.positionId, title: emp.posName }
                        }
                    );
                }

                var curEmps = apGrid.dataSource.filter(function (e) { return e.employees === employees; });

                if (depIds.length == 0 || posIds.length == 0 || employees.length == 0 || curEmps.length > 0)
                    return;

                var isActive = $("#LoansAPIsActive").parent().hasClass('active');
                var notifyEmployee = $("#LoansAPNotify").parent().hasClass('active');
                var isPoster = $("#LoansAPIsPoster").parent().hasClass('active');
                var isAny = $("#LoansAPIsPoster").parent().hasClass('active');

                var getAllEmployeeNames = '';
                var getAllPositionTitles = '';
                var getAllDepartmentNames = '';
                for (var i = 0; i < employees.length; i++) {
                    getAllEmployeeNames += employees[i].name + ((i == employees.length-1)? '' : ', ');
                    getAllPositionTitles += employees[i].position.title + ((i == employees.length-1) ? '' : ', ');
                    getAllDepartmentNames += employees[i].department.name + ((i == employees.length-1) ? '' : ', ');
                }

                var tasks = $('#LoansTasksGrid')[0].ej2_instances[0].dataSource;

                for (var i = 0; i < tasks.length; i++) {
                    tasks[i].apId = getAllEmployeeNames;
                    apGrid.childGrid.dataSource.push(tasks[i]);
                }
                var taskTemplate = { taskTemplateItems: tasks };
                var apRoute =  {
                    id: '',
                    active: isActive,
                    isAny: isAny,
                    notifyEmployee: notifyEmployee,
                    isPoster: isPoster,
                    approvalRouteItemEmployees: employees,
                    taskTemplate: taskTemplate,
                    getAllEmployeeNames: getAllEmployeeNames,
                    getAllPositionTitles: getAllPositionTitles,
                    getAllDepartmentNames: getAllDepartmentNames
                }

                apRoute.id = apRoute.getAllEmployeeNames;
                apRoute.apId = apRoute.getAllEmployeeNames;

                apGrid.dataSource.push(apRoute);
                apGrid.refresh();
            })

            $('#addLoansNewTaskBtn').on('click', function () {
                var isCollapsed = $('#addTaskForm').css('display') == 'none';

                if (isCollapsed) {
                    $('#addLRTaskBtnSection').slideUp(200);
                    $('#addTaskForm').slideDown(200);
                    setTimeout(function () { $('#addLoansNewTaskBtn', '#addLRTaskBtnSection').html('<i class="fa fa-arrow-up p-r-5"></i> Cancel Add') }, 200)
                    $('#addLRTaskBtnSection').slideDown(200);

                } else {
                    $('#addLRTaskBtnSection').slideUp(200);
                    $('#addTaskForm').slideUp(200);
                    setTimeout(function () { $('#addLoansNewTaskBtn', '#addLRTaskBtnSection').html('<i class="fa fa-plus p-r-5"></i> Add Task') }, 200)
                    $('#addLRTaskBtnSection').slideDown(200);
                }
            });
            $("#addLoansTaskBtn").on('click', function (args) {
                var taskGrid = $("#LoansTasksGrid")[0].ej2_instances[0];

                var depIds = $("#loansTaskDepartmentId").val();
                var posIds = $("#loansTaskPositionId").val();
                var empIds = $("#loansTaskEmployeeId").val();
                var emps = curLoansTaskEmployees;

                var employees = [];
                for (var i = 0; i < empIds.length; i++) {
                    var emp = emps.find(x => x.id == empIds[i]);
                    employees.push(
                        {
                            id: emp.id,
                            name: emp.name,
                            department: { id: emp.departmentId, name: emp.depName },
                            position: { id: emp.positionId, title: emp.posName }
                        }
                    );
                }

                var getAllEmployeeNames = '';
                var getAllPositionTitles = '';
                var getAllDepartmentNames = '';
                for (var i = 0; i < employees.length; i++) {
                    getAllEmployeeNames += employees[i].name + ((i == employees.length - 1) ? '' : ', ');
                    getAllPositionTitles += employees[i].position.title + ((i == employees.length - 1) ? '' : ', ');
                    getAllDepartmentNames += employees[i].department.name + ((i == employees.length - 1) ? '' : ', ');
                }

                var curEmps = taskGrid.dataSource.filter(function (e) { return e.getAllEmployeeNames === getAllEmployeeNames && e.getAllPositionTitles === getAllPositionTitles && e.getAllDepartmentNames === getAllDepartmentNames; });

                if (depIds.length == 0 || posIds.length == 0 || employees.length == 0 || curEmps.length > 0)
                    return;

                var isActive = $("#taskIsActive").parent().hasClass('active');
                var notifyEmployee = $("#taskNotify").parent().hasClass('active');
                var isAny = $("#taskAllowAny").parent().hasClass('active');
                var taskDescription = $("#loansTaskDescription").val();

                var task = {
                    id: '',
                    active: isActive,
                    isAny: isAny,
                    taskDescription: taskDescription,
                    notifyEmployee: notifyEmployee,
                    employees: employees,
                    getAllEmployeeNames: getAllEmployeeNames,
                    getAllPositionTitles: getAllPositionTitles,
                    getAllDepartmentNames: getAllDepartmentNames
                }
                task.id = task.getAllEmployeeNames;
                taskGrid.dataSource.push(task);
                taskGrid.refresh();
            })

            $('#loanRequestForm').on('submit', function (e) {
                e.preventDefault();
                if (ValidateForm())
                {
                    Swal.showLoading();

                    let form = [];
                    let lrDetails = $('#loanRequestForm').find("textarea, input").serializeArray();
                    form = form.concat(lrDetails);
                    var params = objectifyForm(form);

                    params.isEditing = isEditingLR;
                    params.LRLoanTypeId = $("#loansLoanTypeId").val();
                    params.LRDepartmentIds = $("#loansDepartmentId").val();
                    params.LRPositionsIds = $("#loansPositionId").val();
                    params.LREmploymentTypeIds = $("#loansEmploymentTypeId").val();
                    params.LREmployeeStatusIds = $("#loansEmployeeStatusId").val();

                    params.ApprovalRoute = $("#LoansApprovalRouteGrid")[0].ej2_instances[0].dataSource;

                    params.LRMinEmployeeDependants = $("#loansMinEmployeeDependants").val();
                    params.LRMaxIndemnityLimit = $("#loansMaxIndemnityLimit").val();
                    params.LRMaxInstallmentsLimit = $("#loansMaxInstallmentsLimit").val();
                    params.LRMaxInstallmentAmount = $("#loansMaxInstallmentAmount").val();

                    if (isEditingLR) {
                        params.Id = curLoansEditRow.id;

                        //cERP.appServices.hR.loanRequestTemplates.update()
                    }
                    else {

                        //cERP.appServices.hR.loanRequestTemplates.update()
                    }
                    let formData = new FormData();
                    formData.append("info", JSON.stringify(params));
                    var xhrToken = $('input:hidden[name="__RequestVerificationToken"]').val();
                    formData.append("__RequestVerificationToken", xhrToken);

                    $.ajax({
                        url: "?handler=LoanRequestTemplate",
                        async: true,
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            var grid = $("#AllLoanRequestsGrid")[0].ej2_instances[0];

                            Swal.hideLoading();
                            if (isEditingLR) {
                                grid.refresh(); // refresh the Grid.

                                swal.fire("Success", "Loan request has successfully been updated", "success");

                                for (var i = 0; i < grid.dataSource.length; i++) {
                                    if (grid.dataSource[i].id == data.id) {
                                        grid.dataSource[i] = data;
                                    }
                                }
                                grid.refresh();
                            }
                            else {
                                grid.dataSource.push(data);
                                grid.refresh(); // refresh the Grid.

                                swal.fire("Success", "Loan request has successfully been added", "success");
                            }
                        },
                        error: function (err) {
                            Swal.hideLoading();
                            if (isEditingLR)
                                swal.fire("Failed", "Loan request couldn't be updated, please fix all errors and try again.", "error");
                            else
                                swal.fire("Failed", "Loan request couldn't be added, please fix all errors and try again.", "error");

                            console.log(err);
                        }
                    });
                }
                else
                {
                    Swal.close();
                    Swal.hideLoading();
                }
            });

            function ValidateForm()
            {
                var elmForm = $("#loanRequestForm");
                // stepDirection === 'forward' :- this condition allows to do the form validation
                // only on forward navigation, that makes easy navigation on backwards still do the validation when going next
                var valid = false;
                elmForm.validator('validate');
                if (elmForm)
                {
                    var elmErr = elmForm.find('.has-error');
                    if (elmErr)
                    {
                        if (elmErr.length > 0)
                        {
                            // Form validation failed
                            valid = false;
                        }
                        else
                        {
                            valid = true;
                        }
                    }
                }
                return valid;
            }
        });
    </script>

<style>
    .e-c-moveup:before {
        content: '\e307'
    }

    .e-c-movedown:before {
        content: '\e305'
    }
</style>

<div class="m-l-20 m-t-0">
    <h2>Loan Requests</h2>
    <p>
        Types of loan requests made by employees
    </p>
</div>
<hr />
<div class="panel-body p-t-0" style="padding-bottom:0;">
    <div class="col-lg-12 padding-right-0">

        <div class="areaHeader" style="display:flex;">
            <div id="loansLoader" class="pull-left loader-inline" style="display:none"></div>        
            <div class="areaHeaderTitle">
                <span id="areHeadertitle" class="menu-text">Current Loan Requests</span>
                @*<span id="subTitle" class="menu-text" style="padding-left:15px; font-size: 28px; font-family:Roboto; font-weight:200;">@ViewData["SubTitle"]</span>*@
            </div>
            @*<h3 class="control-label" style="flex-grow: 1; margin:0">Approval Route</h3>*@
            <div class="pull-right text-right p-r-20 areaHeaderBtnSec">
                @*<div class="clearfix margin-15"></div>*@
                <a id="addLoanRequestBtn" onclick="areaHeaderBtnClick(event); isEditingLR = false;" class="btn btn-outline-dark areaHeaderBtn"><i class="fa fa-plus fa-fw"></i> Add New</a>
            </div>
        </div>
        <form id="loanRequestForm" class="row areaForm" method="post" data-toggle="validator" style="display: none; margin:0; padding:20px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.05), 0 0px 10px 0px rgba(0, 0, 0, 0.05);">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="control-label m-b-5 ">LR Title:</label>
                        <input type="text" id="loansTitle" name="LRTitle" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control " required>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="control-label m-b-5 ">LR Title (In Arabic):</label>
                        <input type="text" id="loansTitleLocalized" name="LRTitleLocalized" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="col-sm-6" style="padding:0">
                        <div class="form-group">
                            <label class="margin-bottom-5 control-label">LR Prefix:</label>
                            <input type="text" id="loansPrefix" name="LRPrefix" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control" required>
                        </div>
                    </div>
                    <div class="col-sm-6" style="padding:0">
                        <div class="form-group">
                            <label class="margin-bottom-5 control-label">LR Starting No:</label>
                            <input type="number" min="0" id="loansStartingNo" name="LRStartingNo" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Loan Type:</label>
                        <select id="loansLoanTypeId" name="LRLoanTypeId" class="form-control" required>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="control-label m-b-5 ">Department:</label>
                        <select id="loansDepartmentId" name="LRDepartmentId" multiple="multiple" class="form-control" onchange="SelectLoansDepartmentPositions();" required>
                        </select>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Position:</label>
                        <select id="loansPositionId" name="LRPositionId" multiple="multiple" class="form-control" required>
                        </select>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Employment Type:</label>
                        <select id="loansEmploymentTypeId" name="EmployementTypeId" multiple="multiple" class="form-control" required>
                        </select>
                        @*<ejs-dropdownlist id="vegetables" placeholder="Select an employment type" popupHeight="200px" dataSource="@employementTypes">
                        <e-dropdownlist-fields text="Value" value="Id"></e-dropdownlist-fields>
                    </ejs-dropdownlist>*@
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Employmee Status:</label>
                        <select id="loansEmployeeStatusId" name="EmployementStatusId" multiple="multiple" class="form-control" required>
                        </select>
                    </div>
                </div>
            </div>
            <hr />
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="control-label m-b-5 ">Min Dependants:</label>
                        <input type="number" min="0" id="loansMinEmployeeDependants" name="LRMinEmployeeDependants" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Maximum Indemnity:</label>
                        <input type="number" min="1" step="0.01" id="loansMaxIndemnityLimit" name="LRMaxIndemnityLimit" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Maximum Installments:</label>
                        <input type="number" min="1" id="loansMaxInstallmentsLimit" name="LRMaxInstallmentsLimit" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="form-group">
                        <label class="margin-bottom-5 control-label">Maximum Amount Per Installment:</label>
                        <input type="number" min="1" step="0.01" id="loansMaxInstallmentAmount" name="LRMaxInstallmentAmount" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                    </div>
                </div>
            </div>
            <hr />
            <div class="areaHeader" style="display:flex;">
                <div class="areaHeaderTitle">
                    <span id="areHeadertitle" class="menu-text">Approval Route</span>
                    @*<span id="subTitle" class="menu-text" style="padding-left:15px; font-size: 28px; font-family:Roboto; font-weight:200;">@ViewData["SubTitle"]</span>*@
                </div>
                @*<h3 class="control-label" style="flex-grow: 1; margin:0">Approval Route</h3>*@
                <div class="pull-right text-right p-r-20 areaHeaderBtnSec">
                    @*<div class="clearfix margin-15"></div>*@
                    <a id="addLoansApprovalRouteBtn" onclick="areaHeaderBtnClick(event)" class="btn btn-outline-dark areaHeaderBtn"><i class="fa fa-plus fa-fw"></i> Add New</a>
                </div>
            </div>
            <div id="addLoansApprovalRouteForm" class="areaForm" role="form" data-toggle="validator" style="display: none">
                <div class="row">
                    <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                        <div class="col-sm-6" style="padding:0">
                            <div class="form-group">
                                <label class="control-label m-b-5 ">Department:</label>
                                <select id="loansAPDepartmentId" name="DepartmentId" multiple="multiple" class="form-control" onchange="SelectLoansAPDepartmentPositions();">
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6" style="padding:0">
                            <div class="form-group">
                                <label class="margin-bottom-5 control-label">Position:</label>
                                <select id="loansAPPositionId" name="PositionId" class="form-control" multiple="multiple" onchange="SelectLoansAPPositionEmployees()">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label class="margin-bottom-5 control-label">Employee:</label>
                            <select id="loansAPEmployeeId" onchange="if ($('#loansAPEmployeeId').val().length > 1) $('#APAllowAnySec').show(); else $('#APAllowAnySec').hide();" name="Employee" multiple="multiple" class="form-control">
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label class="control-label m-b-5 ">Additional Information:</label>

                            <div class="btn-group" data-toggle="buttons">
                                <label class="btn btn-default active">
                                    <input type="checkbox" id="LoansAPIsActive" autocomplete="off"> Active
                                </label>
                                <label class="btn btn-default active">
                                    <input type="checkbox" id="LoansAPNotify" autocomplete="off"> Notify Employee
                                </label>
                                <label class="btn btn-default">
                                    <input type="checkbox" id="LoansAPIsPoster" autocomplete="off"> Allow Posting
                                </label>
                                <label class="btn btn-default" id="APAllowAnySec" style="display:none">
                                    <input type="checkbox" id="LoansAPIsPoster" autocomplete="off"> Allow Any
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                        <label class="margin-bottom-5 control-label"></label>
                        <button id="addToLoansApprovalRouteBtn" type="button" class="btn btn-success btn-block"><i class="fa fa-plus p-r-5"></i> Add To Approval Route</button>
                    </div>
                </div>
                <div class="row m-md-t-5 m-md-b-10">

                </div>
                @*<hr style="margin-top:6px">*@
                <div class="areaHeader" style="display:flex;">
                    <div class="areaHeaderTitle">
                        <span id="areHeadertitle" class="menu-text">Tasks</span>
                        @*<span id="subTitle" class="menu-text" style="padding-left:15px; font-size: 28px; font-family:Roboto; font-weight:200;">@ViewData["SubTitle"]</span>*@
                    </div>
                    @*<h3 class="control-label" style="flex-grow: 1; margin:0">Approval Route</h3>*@
                    <div class="pull-right text-right p-r-20 areaHeaderBtnSec">
                        @*<div class="clearfix margin-15"></div>*@
                        <a id="" onclick="areaHeaderBtnClick(event)" class="btn btn-outline-dark areaHeaderBtn"><i class="fa fa-plus fa-fw"></i> Add New</a>
                    </div>
                </div>
                <div id="addTaskForm" class="areaForm" role="form" data-toggle="validator" style="display: none">
                    <div class="row">
                        <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                            <div class="col-sm-6" style="padding:0">
                                <div class="form-group">
                                    <label class="control-label m-b-5 ">Department:</label>
                                    <select id="loansTaskDepartmentId" name="DepartmentId" multiple="multiple" class="form-control" onchange="SelectLoansTaskDepartmentPositions();">
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6" style="padding:0">
                                <div class="form-group">
                                    <label class="margin-bottom-5 control-label">Position:</label>
                                    <select id="loansTaskPositionId" name="PositionId" multiple="multiple" class="form-control" onchange="SelectLoansTaskPositionEmployees()">
                                        <option></option>

                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="margin-bottom-5 control-label">Employee:</label>
                                <select id="loansTaskEmployeeId" name="Employee" onchange="if ($('#loansTaskEmployeeId').val().length > 1) $('#taskAllowAnySec').show(); else $('#taskAllowAnySec').hide();" multiple="multiple" class="form-control">
                                    <option></option>

                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="margin-bottom-5 control-label">Task Description:</label>
                                <input type="text" id="loansTaskDescription" name="LRTaskDescription" @* value = "@(empInfo!=null? empInfo.EMAIL : "")"*@ class="form-control">
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-6 col-12">
                            <label class="margin-bottom-5 control-label"></label>
                            <button id="addLoansTaskBtn" type="button" class="btn btn-success btn-block"><i class="fa fa-plus p-r-5"></i> Add Task</button>
                        </div>
                    </div>
                    <div class="row m-md-t-5">
                        <div class="form-group">
                            <div class="col-sm-5">
                                <label class="control-label m-b-5 ">Additional Information:</label>
                                <div class="btn-group" data-toggle="buttons">
                                    <label class="btn btn-default active">
                                        <input type="checkbox" id="taskIsActive" autocomplete="off"> Active
                                    </label>
                                    <label class="btn btn-default">
                                        <input type="checkbox" id="taskNotify" autocomplete="off"> Notify Employee
                                    </label>
                                    <label class="btn btn-default" id="taskAllowAnySec" style="display:none">
                                        <input type="checkbox" id="taskAllowAny" autocomplete="off"> Allow Any
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <ejs-grid id="LoansTasksGrid" enableAutoFill="true" columns="@lrTasksGridColumns"
                          dataBound="dataBoundResponsive" commandClick="loansTaskCommandClick" actionBegin="loansTaskActionBegin"
                          allowExcelExport="true" allowPdfExport="true"
                          hierarchyPrintMode="Expanded" allowSelection="true" allowSorting="true"
                          gridLines="Both" rowDataBound="loansTaskRowDataBound"
                          toolbarClick="loansTaskToolbarClick" showColumnChooser="true" toolbar="@initialToolBar"
                          allowResizing="true">

                    <e-grid-sortsettings columns="@(new List<object>() { new { field = "routeIndex", direction = "Ascending" } })"></e-grid-sortsettings>
                    <e-grid-editSettings showDeleteConfirmDialog="true" showConfirmDialog="true" allowAdding="true" allowEditing="true" allowDeleting="true"></e-grid-editSettings>
                    <e-grid-selectionsettings type="Multiple">
                    </e-grid-selectionsettings>
                </ejs-grid>
            </div>
            <ejs-grid id="LoansApprovalRouteGrid" enableAutoFill="true" columns="@lrApprovalRouteGridColumns" childGrid="APSecondaryDetailsGrid" queryString="id"
                      dataBound="dataBoundResponsive" commandClick="loansApprovalRouteCommandClick" actionBegin="loansApprovalRouteActionBegin"
                      allowExcelExport="true" allowPdfExport="true"
                      hierarchyPrintMode="Expanded" allowSelection="true" allowSorting="true"
                      gridLines="Both" rowDataBound="loansApprovalRouteRowDataBound"
                      toolbarClick="loansApprovalRouteToolbarClick" showColumnChooser="true" toolbar="@initialToolBar"
                      allowResizing="true">

                <e-grid-sortsettings columns="@(new List<object>() { new { field = "routeIndex", direction = "Ascending" } })"></e-grid-sortsettings>
                <e-grid-editSettings showDeleteConfirmDialog="true" showConfirmDialog="true" allowAdding="true" allowEditing="true" allowDeleting="true"></e-grid-editSettings>
                <e-grid-selectionsettings type="Multiple">
                </e-grid-selectionsettings>
            </ejs-grid>
            <hr />
            <div class="row">
                <div class="col-lg-12">
                    <input id="submitLoanRequestBtn" type="submit" class="btn btn-success btn-block" value="Add Loan Request" required />
                </div>
            </div>
        </form>
        <div id="loanRequestsCS" class="control-section">
            <ejs-grid id="AllLoanRequestsGrid" enableAutoFill="true" columns="@loanRequestsGridColumns"
                        dataBound="dataBoundResponsive" commandClick="loanRequestsCommandClick" actionBegin="loanRequestsActionBegin"
                        allowExcelExport="true" height="100%" allowPdfExport="true"
                        hierarchyPrintMode="Expanded" allowSelection="true" allowFiltering="true"
                        allowSorting="true" allowMultiSorting="true" gridLines="Both"
                        toolbarClick="loanRequestsToolbarClick" showColumnChooser="true" toolbar="@initialToolBar"
                        allowPaging="true" allowResizing="true">

                @*<e-data-manager url="/api/app/loanRequestTemplates/getAllAsync" adaptor="WebApiAdaptor" ></e-data-manager>*@

                <e-grid-filterSettings type="CheckBox">
                </e-grid-filterSettings>
                <e-grid-editSettings showDeleteConfirmDialog="true" showConfirmDialog="true" allowAdding="true" allowDeleting="true" allowEditing="false"></e-grid-editSettings>
                <e-grid-selectionsettings type="Multiple">
                </e-grid-selectionsettings>
                <e-grid-pagesettings pageCount="5" pageSizes="@(new string[] { "5", "10" , "20", "All" })"></e-grid-pagesettings>
            </ejs-grid>
        </div>
        </div>
    </div>
<script>

    function loanRequestsActionBegin(args) {
        if (args.requestType == "save") {

        }
        else if (args.requestType == "delete") {
            Swal.showLoading();

            console.log(args.data);
            let formData = new FormData();
            formData.append("loanRequests", JSON.stringify(args.data));
            var xhrToken = $('input:hidden[name="__RequestVerificationToken"]').val();
            formData.append("__RequestVerificationToken", xhrToken);

            $.ajax({
                url: '?handler=LoanRequest',
                async: true,
                type: "DELETE",
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    swal.fire("Success", "Loan request(s) successfully deleted", "success");

                    if ($('#loanRequestForm').css('display') !== 'none') {
                        $('#addLoanRequestBtnSection').slideUp(200);
                        $('#loanRequestForm').slideUp(200);
                        setTimeout(function () { $('#addLoanRequestBtn', '#addLoanRequestBtnSection').html('<i class="fa fa-plus p-r-5"></i> Add Loan Request') }, 200)
                        $('#addLoanRequestBtnSection').slideDown(200);
                    }
                },
                error: function (err) {
                    swal.fire("Failed", "Loan request(s) couldn't be deleted, please fix all errors and try again.", "error");

                    console.log(err);
                }
            });
        }
    }
    function loanRequestsCommandClick(args) {
        if (args.commandColumn.type == "Edit") {
            curLoansEditRow = args.rowData;
            isEditingLR = true;
            isEditingLRLoaded = false;
            var isCollapsed = $('#loanRequestForm').css('display') == 'none';

            $('#loansLoader').show();

            var timeout = 0;
            if (!isCollapsed) {
                $('#addLoanRequestBtnSection').slideUp(200);
                $('#loanRequestForm').slideUp(200);

                timeout = 200;
            }
            setTimeout(function () {
                $('#addLoanRequestBtnSection').slideUp(200);
                $('#loanRequestForm').slideDown(200);
                $('#addLoanRequestBtnSection').slideDown(200);

                setTimeout(function () {
                    $('#addLoanRequestBtn', '#addLoanRequestBtnSection').html('<i class="fa fa-arrow-up p-r-5"></i> Cancel Update');
                    $('#submitLoanRequestBtn').val('Update Loan Request');

                    $('#loansTitle').val(curLoansEditRow.title);
                    $('#loansTitleLocalized').val(curLoansEditRow.titleLocalized);
                    $('#loansPrefix').val(curLoansEditRow.prefix);
                    $('#loansStartingNo').val(curLoansEditRow.startingNo);

                    var apGrid = $("#LoansApprovalRouteGrid")[0].ej2_instances[0];
                    apGrid.showSpinner();
                    apGrid.dataSource = null;
                    cERP.appServices.hR.loanRequestService.loanRequestTemplates.getCustom(curLoansEditRow.id).done(function (data) {
                        curLoansEditRow = data;

                        $('#loansEntitlementDays').val(curLoansEditRow.entitlementDays);
                        $("#loansLoanTypeId").multiselect('select', curLoansEditRow.loanTypeId);
                        $('#loansLoanTypeId').multiselect('refresh');

                        $('#loansDepartmentId').multiselect('deselectAll', false);
                        $('#loansPositionId').multiselect('deselectAll', false);
                        $('#loansEmploymentTypeId').multiselect('deselectAll', false);
                        $('#loansEmployeeStatusId').multiselect('deselectAll', false);

                        $("#loansMinEmployeeDependants").val(curLoansEditRow.minEmployeeDependants);
                        $("#loansMaxIndemnityLimit").val(curLoansEditRow.maxIndemnityLimit);
                        $("#loansMaxInstallmentsLimit").val(curLoansEditRow.maxInstallmentsLimit);
                        $("#loansMaxInstallmentAmount").val(curLoansEditRow.maxInstallmentAmount);

                        var departs = [];
                        for (var i = 0; i < curLoansEditRow.departments.length; i++) {
                            departs.push(curLoansEditRow.departments[i].departmentId);
                        }
                        $('#loansDepartmentId').multiselect('select', departs);
                        $('#loansDepartmentId').change();
                        var empTypes = [];
                        for (var i = 0; i < curLoansEditRow.employmentTypes.length; i++) {
                            empTypes.push(curLoansEditRow.employmentTypes[i].employmentTypeId);
                        }
                        $('#loansEmploymentTypeId').multiselect('select', empTypes);
                        var empStatuses = [];
                        for (var i = 0; i < curLoansEditRow.employeeStatuses.length; i++) {
                            empStatuses.push(curLoansEditRow.employeeStatuses[i].employeeStatusId);
                        }
                        $('#loansEmployeeStatusId').multiselect('select', empStatuses);

                        //cERP.appServices.app.approvalRouteService.approvalRouteTemplates.getFull(curLoansEditRow.approvalRouteTemplateId).done(function (data) {
                        var data = curLoansEditRow.approvalRouteTemplate;
                        apGrid.hideSpinner();
                        apGrid.dataSource = data.approvalRouteTemplateItems;
                        console.log(data);
                        var allTaskTemplateItems = [];
                        for (var i = 0; i < data.approvalRouteTemplateItems.length; i++) {
                            var approvalRouteTempItem = data.approvalRouteTemplateItems[i];
                            approvalRouteTempItem.apId = i;
                            if (approvalRouteTempItem.taskTemplate != null) {
                                for (var j = 0; j < approvalRouteTempItem.taskTemplate.taskTemplateItems.length; j++) {
                                    var taskTemplateItem = approvalRouteTempItem.taskTemplate.taskTemplateItems[j];
                                    taskTemplateItem.apId = i;
                                    allTaskTemplateItems.push(taskTemplateItem);
                                }
                            }
                        }
                        apGrid.childGrid.dataSource = allTaskTemplateItems;
                        apGrid.refresh();
                        //});
                        //for (var i = 0; i < approvalItems.length; i++) {
                        //    if (!approvalItems[i].isDepartmentHead && !approvalItems[i].isReportingTo) {
                        //        cERP.appServices.setup.departmentSetup.department.get(approvalItems[i].departmentId).done(function (data) {
                        //            approvalItems[i].department = data;
                        //        })
                        //        cERP.appServices.setup.positionSetup.position.get(approvalItems[i].positionId).done(function (data) {
                        //            approvalItems[i].position = data;
                        //        })
                        //        cERP.appServices.hR.employeeService.employee.get(approvalItems[i].employeeId).done(function (data) {
                        //            approvalItems[i].employee = data;
                        //        })
                        //    }
                        //}


                        $('#loansLoader').hide();
                    });
                }, 150);
            }, timeout);
        }
        else if (args.commandColumn.type == "Copy") {
            this.copy(false);
        }
    }
    function loanRequestsToolbarClick(args) {
        var gridObj = document.getElementById("AllLoanRequestsGrid").ej2_instances[0];
        if (args.item.id === 'AllLoanRequestsGrid_pdfexport') {
            gridObj.pdfExport();
        }
        if (args.item.id === 'AllLoanRequestsGrid_excelexport') {
            gridObj.excelExport();
        }
        if (args.item.id === 'AllLoanRequestsGrid_csvexport') {
            gridObj.csvExport();
        }
        if (this.getSelectedRecords().length > 0) {
            var withHeader = false;
            if (args.item.id === 'copyHeader') {
                withHeader = true;
            }
            this.copy(withHeader);
        }
        else {
            if (args.item.id === 'copyHeader') {
                var dialogObj = document.getElementById('alert_dialog').ej2_instances[0];
                dialogObj.show();
            }
            else if (args.item.id === 'copy') {
                var dialogObj = document.getElementById('alert_dialog_1').ej2_instances[0];
                dialogObj.show();
            }
        }
        if (args.item.id === 'showActions') {
            gridObj.toolbar = [{ text: "Hide Actions", tooltipText: "Actions", prefixIcon: "e-custom-hide-actions", id: "hideActions" }, { text: "Toggle Grouping", tooltipText: "Grouping", prefixIcon: "e-custom-group-toggle", id: "toggleGrouping" }, { text: "Toggle Detailed", tooltipText: "Toggle Detailed", prefixIcon: "e-toggledetailed", id: "toggleDetailed" }, "ExcelExport", "CsvExport", "Print", "Search", "Delete", { text: "Copy", tooltipText: "Copy", prefixIcon: "e-copy", id: "copy" }, { text: "Copy With Header", tooltipText: "Copy With Header", prefixIcon: "e-copy", id: "copyHeader" }, "ColumnChooser"];
            gridObj.refresh();
        }
        if (args.item.id === 'hideActions') {
            gridObj.toolbar = [{ text: "Show Actions", tooltipText: "Actions", prefixIcon: "e-custom-show-actions", id: "showActions" }, "Search", "ColumnChooser"];
            gridObj.showColumnChooser = true;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleGrouping') {
            gridObj.allowGrouping = !gridObj.allowGrouping;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleDetailed') {
            var visCount = 0;
            for (var i = 0; i < gridObj.columns.length; i++) {
                if (gridObj.columns[i].visible) visCount++;
            }
            if (visCount == gridObj.columns.length) {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (typeof col.customAttributes != 'undefined' && typeof col.customAttributes.id != 'undefined' && col.customAttributes.id == 'detailed')
                        gridObj.showHider.hide(col.headerText, 'headerText');
                    else if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
            else {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
        }
    }


    function loansApprovalRouteActionBegin(args) {
        if (args.requestType == "save") {

        }
        else if (args.requestType == "delete") {
        }
    }
    function loansApprovalRouteCommandClick(args) {
        if (args.commandColumn.type == "MoveUp") {
            var grid = $('#LoansApprovalRouteGrid')[0].ej2_instances[0];
            var rI = args.rowData.routeIndex - 1;
            if (rI < 1) return;
            array_move(grid.dataSource, rI, rI - 1);
            for (var i = 0; i < grid.dataSource.length; i++) {
                grid.dataSource[i].routeIndex = i + 1;
            }
            grid.refresh();
        }
        if (args.commandColumn.type == "MoveDown") {
            var grid = $('#LoansApprovalRouteGrid')[0].ej2_instances[0];
            var rI = args.rowData.routeIndex - 1;
            if (rI == grid.dataSource.length) return;
            array_move(grid.dataSource, rI, rI + 1);
            for (var i = 0; i < grid.dataSource.length; i++) {
                grid.dataSource[i].routeIndex = i + 1;
            }
            grid.refresh();

        }
        if (args.commandColumn.type == "Edit") {

        }
        else if (args.commandColumn.type == "Copy") {
            this.copy(false);
        }
    }
    function loansApprovalRouteToolbarClick(args) {
        var gridObj = document.getElementById("LoansApprovalRouteGrid").ej2_instances[0];
        if (args.item.id === 'LRApprovalRouteGrid_pdfexport') {
            gridObj.pdfExport();
        }
        if (args.item.id === 'LRApprovalRouteGrid_excelexport') {
            gridObj.excelExport();
        }
        if (args.item.id === 'LRApprovalRouteGrid_csvexport') {
            gridObj.csvExport();
        }
        if (this.getSelectedRecords().length > 0) {
            var withHeader = false;
            if (args.item.id === 'copyHeader') {
                withHeader = true;
            }
            this.copy(withHeader);
        }
        else {
            if (args.item.id === 'copyHeader') {
                var dialogObj = document.getElementById('alert_dialog').ej2_instances[0];
                dialogObj.show();
            }
            else if (args.item.id === 'copy') {
                var dialogObj = document.getElementById('alert_dialog_1').ej2_instances[0];
                dialogObj.show();
            }
        }
        if (args.item.id === 'showActions') {
            gridObj.toolbar = [{ text: "Hide Actions", tooltipText: "Actions", prefixIcon: "e-custom-hide-actions", id: "hideActions" }, { text: "Toggle Grouping", tooltipText: "Grouping", prefixIcon: "e-custom-group-toggle", id: "toggleGrouping" }, { text: "Move Up", tooltipText: "Move Up", prefixIcon: "e-c-moveup", id: "moveUp" }, { text: "Move Down", tooltipText: "Move Down", prefixIcon: "e-c-movedown", id: "moveDown" }, { text: "Toggle Detailed", tooltipText: "Toggle Detailed", prefixIcon: "e-toggledetailed", id: "toggleDetailed" }, "ExcelExport", "CsvExport", "Print", "Search", "Delete", { text: "Copy", tooltipText: "Copy", prefixIcon: "e-copy", id: "copy" }, { text: "Copy With Header", tooltipText: "Copy With Header", prefixIcon: "e-copy", id: "copyHeader" }, "ColumnChooser"];
            gridObj.refresh();
        }
        if (args.item.id === 'hideActions') {
            gridObj.toolbar = [{ text: "Show Actions", tooltipText: "Actions", prefixIcon: "e-custom-show-actions", id: "showActions" }, "Search", "ColumnChooser"];
            gridObj.showColumnChooser = true;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleGrouping') {
            gridObj.allowGrouping = !gridObj.allowGrouping;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleDetailed') {
            var visCount = 0;
            for (var i = 0; i < gridObj.columns.length; i++) {
                if (gridObj.columns[i].visible) visCount++;
            }
            if (visCount == gridObj.columns.length) {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (typeof col.customAttributes != 'undefined' && typeof col.customAttributes.id != 'undefined' && col.customAttributes.id == 'detailed')
                        gridObj.showHider.hide(col.headerText, 'headerText');
                    else if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
            else {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
        }

        if (args.item.id === 'moveUp') {
            var selected = gridObj.getSelectedRecords();
            for (var i = 0; i < selected.length; i++) {
                var cur = selected[i];
                let rI = cur.routeIndex - 1;
                if (rI - 1 < 0)
                    break;
                array_move(gridObj.dataSource, rI, rI - 1);
            }
            for (var i = 0; i < gridObj.dataSource.length; i++) {
                if (typeof (gridObj.dataSource[i]) !== 'undefined') {
                    gridObj.dataSource[i].routeIndex = i + 1;
                }
            }
            gridObj.refresh();
        }
        if (args.item.id === 'moveDown') {
            var selected = gridObj.getSelectedRecords()
            for (var i = selected.length - 1; i > -1; i--) {
                var cur = selected[i];
                let rI = cur.routeIndex - 1;
                if (rI + 1 > gridObj.dataSource.length - 1)
                    break;
                array_move(gridObj.dataSource, rI, rI + 1);
            }
            for (var i = 0; i < gridObj.dataSource.length; i++) {
                if (typeof (gridObj.dataSource[i]) !== 'undefined') {
                    gridObj.dataSource[i].routeIndex = i + 1;
                }
            }
            gridObj.refresh();
        }
        if (args.requestType == "beginEdit") {
            var Obj = $("#LoansApprovalRouteGrid")[0].ej2_instances[0];
            var ajax = new ej.base.Ajax('?handler=LRApprovalRouteData', 'GET');
            ajax.send();
            ajax.onSuccess = function (data) {
                var ds = JSON.parse(data);
                ds.push(args.rowData.valueTypeForDescription);
                Obj.columns[4].edit.params.dataSource = ds;
                //ddldist.dataBind();
            };

            Obj.columns[4].allowEditing = false;
        }
    }
    function loansApprovalRouteRowDataBound(args) {
        if (args.data.isDepartmentHead || args.data.isReportingTo) {
            $(".e-" + "DeleteButton", args.row).addClass("e-hide");
        }
        else {
            $(".e-" + "DeleteButton", args.row).removeClass("e-hide");

        }
    }

    function loansTaskActionBegin(args) {
        if (args.requestType == "save") {

        }
        else if (args.requestType == "delete") {
        }
    }
    function loansTaskCommandClick(args) {
        if (args.commandColumn.type == "MoveUp") {
            var grid = $('#LoansTasksGrid')[0].ej2_instances[0];
            var rI = args.rowData.routeIndex - 1;
            if (rI < 1) return;
            array_move(grid.dataSource, rI, rI - 1);
            for (var i = 0; i < grid.dataSource.length; i++) {
                grid.dataSource[i].routeIndex = i + 1;
            }
            grid.refresh();
        }
        if (args.commandColumn.type == "MoveDown") {
            var grid = $('#LoansTasksGrid')[0].ej2_instances[0];
            var rI = args.rowData.routeIndex - 1;
            if (rI == grid.dataSource.length) return;
            array_move(grid.dataSource, rI, rI + 1);
            for (var i = 0; i < grid.dataSource.length; i++) {
                grid.dataSource[i].routeIndex = i + 1;
            }
            grid.refresh();

        }
        if (args.commandColumn.type == "Edit") {

        }
        else if (args.commandColumn.type == "Copy") {
            this.copy(false);
        }
    }
    function loansTaskToolbarClick(args) {
        var gridObj = document.getElementById("LoansTasksGrid").ej2_instances[0];
        if (args.item.id === 'LoansTasksGrid_pdfexport') {
            gridObj.pdfExport();
        }
        if (args.item.id === 'LoansTasksGrid_excelexport') {
            gridObj.excelExport();
        }
        if (args.item.id === 'LoansTasksGrid_csvexport') {
            gridObj.csvExport();
        }
        if (this.getSelectedRecords().length > 0) {
            var withHeader = false;
            if (args.item.id === 'copyHeader') {
                withHeader = true;
            }
            this.copy(withHeader);
        }
        else {
            if (args.item.id === 'copyHeader') {
                var dialogObj = document.getElementById('alert_dialog').ej2_instances[0];
                dialogObj.show();
            }
            else if (args.item.id === 'copy') {
                var dialogObj = document.getElementById('alert_dialog_1').ej2_instances[0];
                dialogObj.show();
            }
        }
        if (args.item.id === 'showActions') {
            gridObj.toolbar = [{ text: "Hide Actions", tooltipText: "Actions", prefixIcon: "e-custom-hide-actions", id: "hideActions" }, { text: "Toggle Grouping", tooltipText: "Grouping", prefixIcon: "e-custom-group-toggle", id: "toggleGrouping" }, { text: "Toggle Detailed", tooltipText: "Toggle Detailed", prefixIcon: "e-toggledetailed", id: "toggleDetailed" }, { text: "Move Up", tooltipText: "Move Up", prefixIcon: "e-c-moveup", id: "moveUp" }, { text: "Move Down", tooltipText: "Move Down", prefixIcon: "e-c-movedown", id: "moveDown" }, "ExcelExport", "CsvExport", "Print", "Search", "Delete", { text: "Copy", tooltipText: "Copy", prefixIcon: "e-copy", id: "copy" }, { text: "Copy With Header", tooltipText: "Copy With Header", prefixIcon: "e-copy", id: "copyHeader" }, "ColumnChooser"];
            gridObj.refresh();
        }
        if (args.item.id === 'hideActions') {
            gridObj.toolbar = [{ text: "Show Actions", tooltipText: "Actions", prefixIcon: "e-custom-show-actions", id: "showActions" }, "Search", "ColumnChooser"];
            gridObj.showColumnChooser = true;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleGrouping') {
            gridObj.allowGrouping = !gridObj.allowGrouping;
            gridObj.refresh();
        }
        if (args.item.id === 'toggleDetailed') {
            var visCount = 0;
            for (var i = 0; i < gridObj.columns.length; i++) {
                if (gridObj.columns[i].visible) visCount++;
            }
            if (visCount == gridObj.columns.length) {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (typeof col.customAttributes != 'undefined' && typeof col.customAttributes.id != 'undefined' && col.customAttributes.id == 'detailed')
                        gridObj.showHider.hide(col.headerText, 'headerText');
                    else if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
            else {
                for (var i = 0; i < gridObj.columns.length; i++) {
                    var col = gridObj.columns[i];
                    if (col.showInColumnChooser)
                        gridObj.showHider.show(col.headerText, 'headerText');
                }
            }
        }
        if (args.item.id === 'moveUp') {
            var selected = gridObj.getSelectedRecords();
            for (var i = 0; i < selected.length; i++) {
                var cur = selected[i];
                let rI = cur.routeIndex - 1; 
                if (rI - 1 < 0)
                    break;
                array_move(gridObj.dataSource, rI, rI - 1);
            }
            for (var i = 0; i < gridObj.dataSource.length; i++) {
                if (typeof (gridObj.dataSource[i]) !== 'undefined') {
                    gridObj.dataSource[i].routeIndex = i + 1;
                }
            }
            gridObj.refresh();
        }
        if (args.item.id === 'moveDown') {
            var selected = gridObj.getSelectedRecords()
            for (var i = selected.length-1; i > -1; i--) {
                var cur = selected[i];
                let rI = cur.routeIndex - 1; 
                if (rI + 1 > gridObj.dataSource.length - 1)
                    break;
                array_move(gridObj.dataSource, rI, rI + 1);
            }
            for (var i = 0; i < gridObj.dataSource.length; i++) {
                if (typeof (gridObj.dataSource[i]) !== 'undefined') {
                    gridObj.dataSource[i].routeIndex = i + 1;
                }
            }
            gridObj.refresh();
        }
    }
    function loansTaskRowDataBound(args) {
        //if (args.data.isDepartmentHead || args.data.isReportingTo) {
        //    $(".e-" + "DeleteButton", args.row).addClass("e-hide");
        //}
        //else {
        //    $(".e-" + "DeleteButton", args.row).removeClass("e-hide");

        //}
    }

    function alertBtnClick() {
        var dialogObj = document.getElementById('alert_dialog').ej2_instances[0];
        var dialogObj1 = document.getElementById('alert_dialog_1').ej2_instances[0];
        dialogObj.hide();
        dialogObj1.hide();
    }

    var curLoanPositions = [];
    function SelectLoansDepartmentPositions() {
        var departmentIds = $("#loansDepartmentId").val();
        $("#loansPositionId").empty();
        if (departmentIds.length == 0) return;
        $.ajax({
            type: "GET",
            url: '?handler=DepartmentsPositions',
            data: { departmentIds: JSON.stringify(departmentIds) },
            success: function (data) {
                var dataMS = [];
                $.each(departmentIds, function (i, departmentId) {
                    var positions = [];
                    $.each(data, function (j, position) {
                        if (position.departmentId == departmentId)
                            positions.push({ label: position.title, value: position.id });
                    });
                    dataMS.push({
                        label: $(`#loansDepartmentId option[value='${departmentId}']`).text(), children: positions
                    });
                });
                curLoanPositions = dataMS;
                $("#loansPositionId").multiselect('dataprovider', dataMS);
                if (isEditingLR && !isEditingLRLoaded) {
                    var posits = [];
                    for (var i = 0; i < curLoansEditRow.positions.length; i++) {
                        posits.push(curLoansEditRow.positions[i].positionId);
                    }
                    $("#loansPositionId").multiselect('select', posits);

                    isEditingLRLoaded = true;
                }

            }
        });
    }

    var curLoansAPPositions = [];
    function SelectLoansAPDepartmentPositions() {
        var departmentIds = $("#loansAPDepartmentId").val();
        $("#loansAPPositionId").empty();
        $("#loansAPEmployeeId").empty();
        curLoansAPPositions = [];
        if (departmentIds.length == 0) return;
        $.ajax({
            type: "GET",
            url: '?handler=DepartmentsPositions',
            data: { departmentIds: JSON.stringify(departmentIds) },
            success: function (data) {
                var dataMS = [];
                $.each(departmentIds, function (i, departmentId) {
                    var positions = [];
                    $.each(data, function (j, position) {
                        if (position.departmentId == departmentId)
                            positions.push({ label: position.title, value: position.id });
                    });
                    dataMS.push({
                        label: $(`#loansDepartmentId option[value='${departmentId}']`).text(), children: positions
                    });
                });
                curLoansAPPositions = data;
                $("#loansAPPositionId").multiselect('dataprovider', dataMS);
            }
        });
    }

    var curLoansAPEmployees = [];
    function SelectLoansAPPositionEmployees() {
        var positionIds = $("#loansAPPositionId").val();
        var positions = curLoansAPPositions;
        //var departmentIds = $("#loansAPDepartmentId").val();
        $("#loansAPEmployeeId").empty();
        curLoansAPEmployees = [];
        if (positionIds.length == 0) return;

        $.ajax({
            type: "GET",
            url: '?handler=Employees',
            data: { positionIds: JSON.stringify(positionIds) },
            success: function (data) {
                var positionEmployees = [];

                $.each(positionIds, function (i, positionId) {
                    var position = positions.find(function (x) { return x.id == positionId });
                    var employees = [];
                    $.each(data, function (j, employee) {
                        if (employee.posId == positionId) {
                            var emp = { id: employee.id, value: employee.id, name: employee.name, label: employee.name, departmentId: employee.depId, depName: employee.depName, positionId: employee.posId, posName: employee.posTitle };
                            employees.push(emp);
                            curLoansAPEmployees.push(emp);
                        }
                    });
                    positionEmployees.push({ label: position.title, children: employees })
                });
                $("#loansAPEmployeeId").multiselect('dataprovider', positionEmployees);
            }
        });
    }

    var curLoansTaskPositions = [];
    function SelectLoansTaskDepartmentPositions() {
        var departmentIds = $("#loansTaskDepartmentId").val();
        $("#loansTaskPositionId").empty();
        $("#loansTaskEmployeeId").empty();
        curLoansTaskPositions = [];
        if (departmentIds.length == 0) return;
        $.ajax({
            type: "GET",
            url: '?handler=DepartmentsPositions',
            data: { departmentIds: JSON.stringify(departmentIds) },
            success: function (data) {
                var dataMS = [];
                $.each(departmentIds, function (i, departmentId) {
                    var positions = [];
                    $.each(data, function (j, position) {
                        if (position.departmentId == departmentId)
                            positions.push({ label: position.title, value: position.id });
                    });
                    dataMS.push({
                        label: $(`#loansDepartmentId option[value='${departmentId}']`).text(), children: positions
                    });
                });
                curLoansTaskPositions = data;
                $("#loansTaskPositionId").multiselect('dataprovider', dataMS);
            }
        });
    }
    var curLoansTaskEmployees = [];
    function SelectLoansTaskPositionEmployees() {
        var positionIds = $("#loansTaskPositionId").val();
        var positions = curLoansTaskPositions;
        //var departmentIds = $("#loansAPDepartmentId").val();
        $("#loansTaskEmployeeId").empty();
        curLoansTaskEmployees = [];
        if (positionIds.length == 0) return;

        $.ajax({
            type: "GET",
            url: '?handler=Employees',
            data: { positionIds: JSON.stringify(positionIds) },
            success: function (data) {
                var positionEmployees = [];

                $.each(positionIds, function (i, positionId) {
                    var position = positions.find(function (x) { return x.id == positionId });
                    var employees = [];
                    $.each(data, function (j, employee) {
                        if (employee.posId == positionId) {
                            var emp = { id: employee.id, value: employee.id, name: employee.name, label: employee.name, departmentId: employee.depId, depName: employee.depName, positionId: employee.posId, posName: employee.posTitle };
                            employees.push(emp);
                            curLoansTaskEmployees.push(emp);
                        }
                    });
                    positionEmployees.push({ label: position.title, children: employees })
                });
                $("#loansTaskEmployeeId").multiselect('dataprovider', positionEmployees);
            }
        });
    }

</script>
